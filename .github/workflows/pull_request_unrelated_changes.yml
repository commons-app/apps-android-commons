name: Check Pull Request Scope

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write
  models: read

jobs:
  check-scope:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect changed files
        id: changed
        shell: bash
        run: |
          git fetch origin "${{ github.base_ref }}" --depth=1 || true
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          git diff --name-only "origin/${{ github.base_ref }}" "${{ github.sha }}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Analyze pull request with AI
        id: analyze
        uses: actions/ai-inference@v1
        with:
          model: openai/gpt-4o-mini
          max-tokens: 20
          prompt: |
            Analyse this pull request to determine if it contains unrelated changes.

            Pull Request Title:
            ${{ github.event.pull_request.title }}

            Pull Request Description:
            ${{ github.event.pull_request.body }}

            Changed files:
            ${{ steps.changed.outputs.files }}

            Does this pull request appear to mix unrelated changes?
            Respond with only "yes" or "no".

      - name: Comment if unrelated changes detected
        if: steps.analyze.outputs.response == 'yes'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "This pull request appears to contain unrelated changes. Please consider splitting it into separate PRs."
            });
