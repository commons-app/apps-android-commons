name: Inactivity Manager

on:
  schedule:
    - cron: '0 0 * * *' # runs thee task every day at midnight
  workflow_dispatch: # allows for the manual testing

permissions:
  issues: write

jobs:
  manage-stale-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Handle stale assignments
        uses: actions/github-script@v7
        with:
          script: |
            const daysToReminder = 30;
            const daysToWarning = 44; 
            const daysToUnassign = 58;
            const keepTag = "#keep";

            // fetches the all open issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            for (const issue of issues.data) {
              // skip the ossue if no one is assigned
              if (issue.assignees.length === 0) continue;

              const assignee = issue.assignees[0].login;
              const lastUpdate = new Date(issue.updated_at);
              const now = new Date();
              const diffDays = Math.ceil((now - lastUpdate) / (1000 * 60 * 60 * 24));

              // if acivity within 30 days then skip 
              if (diffDays < daysToReminder) continue;

              // get the comments to check for the 'keep' keyword from the assigne
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });

              // check if the very last comment is from the assignee and contains the "keep" keyword
              const lastComment = comments.data.length > 0 ? comments.data[comments.data.length - 1] : null;
            
              if (lastComment && lastComment.user.login === assignee) {
                // we use toLowerCase() so #KEEP or #keep both will be work
                if (lastComment.body.toLowerCase().includes(keepTag)) {
                  console.log(`Issue #${issue.number} protected: @${assignee} used the ${keepTag} tag.`);
                  continue; 
                }
              }

              if (diffDays >= daysToUnassign) {
                // stagee 3: unassigning
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `Hi @${assignee}! üëã I'm unassigning this for now so that others can give it a try. If you get some time later, feel free to ask to be assigned again - you are always welcome! üöÄüòä`
                });
                await github.rest.issues.removeAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  assignees: [assignee]
                });
              } else if (diffDays >= daysToWarning) {
                // stage 2: gentle warning
                const hasWarning = comments.data.some(c => c.body.includes("might unassign it in 2 weeks"));
                if (!hasWarning) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `Hi @${assignee}! Gentle ping, did you have time to look at this issue? üîç If you are too busy, we might unassign it in 2 weeks so that someone else gets a chance to give it a try. (Tip: Include "**#KEEP**" in your reply to stay assigned!) Thank you for your understanding! ‚òï‚ú®`
                  });
                }
              } else if (diffDays >= daysToReminder) {
                // stage 1: initial check-in
                const hasReminder = comments.data.some(c => c.body.includes("Any progress to share?"));
                if (!hasReminder) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `Hi @${assignee}! Any progress to share? üìà Even if you don't have a solution yet, would you mind sharing what you found or tried? I assume you still intend to work on this, but if not please let us know! ü§ùüíª`
                  });
                }
              }
            }